From 9fd34f786b316765b7a31305948ecb40c01bc6c6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bart=C5=82omiej=20Burdukiewicz?=
 <bartlomiej.burdukiewicz@gmail.com>
Date: Thu, 22 Oct 2020 17:52:55 +0200
Subject: [PATCH] make tls-elf more optional (mesa 20.2.1).
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Bart≈Çomiej Burdukiewicz <bartlomiej.burdukiewicz@gmail.com>
---
 meson.build       | 2 +-
 meson_options.txt | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index fbd3c4b..8c8c224 100644
--- a/meson.build
+++ b/meson.build
@@ -424,7 +424,7 @@ endif
 
 # Android uses emutls for versions <= P/28. For USE_ELF_TLS we need ELF TLS.
 use_elf_tls = false
-if not ['windows', 'freebsd', 'openbsd'].contains(host_machine.system()) and (not with_platform_android or get_option('platform-sdk-version') >= 29)
+if not ['windows', 'freebsd', 'openbsd'].contains(host_machine.system()) and (not with_platform_android or get_option('platform-sdk-version') >= 29) and get_option('elf-tls')
   pre_args += '-DUSE_ELF_TLS'
   use_elf_tls = true
 endif
diff --git a/meson_options.txt b/meson_options.txt
index 2d39d13..72006eb 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -368,6 +368,12 @@ option(
   value : true,
   description : 'Enable direct rendering in GLX and EGL for DRI',
 )
+option(
+  'elf-tls',
+  type : 'boolean',
+  value : true,
+  description : 'Enable TLS support in ELF',
+)
 option(
   'prefer-iris',
   type : 'boolean',
